{% extends 'telemetry/base.html' %}
{% load static %}

{% block title %}Analysis Dashboard - Ridgway Garage{% endblock %}

{% block main_class %}container-fluid p-0{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        display: flex;
        height: calc(100vh - 56px); /* Full height minus navbar */
        overflow: hidden;
        width: 100%;
        margin: 0;
        padding: 0;
        position: relative;
    }

    .channel-sidebar {
        width: 280px;
        min-width: 280px;
        border-right: 1px solid #495057;
        overflow-y: auto;
        padding: 1rem;
        background-color: #212529;
        transition: all 0.3s ease-in-out;
        position: relative;
    }

    .channel-sidebar.collapsed {
        width: 0;
        min-width: 0;
        padding: 0;
        border-right: none;
        overflow: hidden;
    }

    .channel-group {
        margin-bottom: 1.5rem;
    }

    .channel-group-header {
        font-weight: bold;
        font-size: 0.875rem;
        text-transform: uppercase;
        color: #adb5bd;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .channel-checkbox {
        margin-bottom: 0.25rem;
    }

    .channel-checkbox label {
        font-size: 0.875rem;
        cursor: pointer;
    }

    .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .laps-sidebar {
        width: 320px;
        min-width: 320px;
        border-left: 1px solid #495057;
        overflow-y: auto;
        padding: 1rem;
        background-color: #212529;
        transition: all 0.3s ease-in-out;
        position: relative;
    }

    .laps-sidebar.collapsed {
        width: 0;
        min-width: 0;
        padding: 0;
        border-left: none;
        overflow: hidden;
    }

    .sidebar-toggle {
        position: absolute;
        top: 10px;
        z-index: 1000;
        background-color: #343a40;
        border: 1px solid #495057;
        color: #fff;
        padding: 0.375rem 0.5rem;
        cursor: pointer;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .sidebar-toggle:hover {
        background-color: #495057;
    }

    .channel-sidebar .sidebar-toggle {
        right: 10px;
    }

    .laps-sidebar .sidebar-toggle {
        left: 10px;
    }

    .sidebar-toggle-floating {
        position: fixed;
        z-index: 1001;
        background-color: #343a40;
        border: 1px solid #495057;
        color: #fff;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        transition: all 0.2s;
        top: 70px;
    }

    .sidebar-toggle-floating:hover {
        background-color: #495057;
    }

    .sidebar-toggle-floating.left {
        left: 10px;
    }

    .sidebar-toggle-floating.right {
        right: 10px;
    }

    .filter-bar {
        background-color: #343a40;
        padding: 1rem;
        border-bottom: 1px solid #495057;
        margin: -1rem -1rem 1rem -1rem;
    }

    .lap-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #343a40;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 2px solid transparent;
    }

    .lap-item:hover {
        background-color: #495057;
    }

    .lap-item.active {
        border-color: #0d6efd;
        background-color: #1a3a5c;
    }

    .lap-time {
        font-size: 1.125rem;
        font-weight: bold;
        color: #00d1b2;
    }

    .lap-meta {
        font-size: 0.75rem;
        color: #adb5bd;
        margin-top: 0.25rem;
    }

    .pb-badge {
        background-color: #ffc107;
        color: #000;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.625rem;
        font-weight: bold;
        margin-left: 0.25rem;
    }

    .chart-container {
        margin-bottom: 1rem;
    }

    #map {
        height: 400px;
        width: 100%;
        margin-top: 1rem;
        border-radius: 0.375rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .btn-group-xs .btn {
        padding: 0.125rem 0.375rem;
        font-size: 0.75rem;
    }

    .lap-color-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .section-title {
        font-size: 0.875rem;
        font-weight: bold;
        text-transform: uppercase;
        color: #adb5bd;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #495057;
    }

    .current-laps-container {
        margin-bottom: 1.5rem;
        padding: 0.75rem;
        background-color: #1a1d20;
        border-radius: 0.375rem;
    }

    .current-lap-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        margin: 0.25rem;
        background-color: #343a40;
        border-radius: 1rem;
        font-size: 0.813rem;
    }

    .current-lap-chip .btn-close {
        margin-left: 0.5rem;
        font-size: 0.625rem;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Floating toggle buttons (shown when sidebars are collapsed) -->
<button id="toggleLeftFloating" class="sidebar-toggle-floating left" style="display: none;">
    <i class="bi bi-list"></i> Channels
</button>
<button id="toggleRightFloating" class="sidebar-toggle-floating right" style="display: none;">
    <i class="bi bi-list"></i> Laps
</button>

<div class="dashboard-container">
    <!-- Left Sidebar: Channel Selector -->
    <div class="channel-sidebar" id="channelSidebar">
        <button id="toggleLeftSidebar" class="sidebar-toggle">
            <i class="bi bi-chevron-left"></i>
        </button>
        <h6 class="mb-3">Telemetry Channels</h6>

        {% for group_key, group in channel_groups.items %}
        <div class="channel-group">
            <div class="channel-group-header">
                <span>{{ group.name }}</span>
                <div class="btn-group-xs" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm select-all" data-group="{{ group_key }}">All</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm select-none" data-group="{{ group_key }}">None</button>
                </div>
            </div>
            {% for channel in group.channels %}
            <div class="form-check channel-checkbox">
                <input class="form-check-input channel-input"
                       type="checkbox"
                       id="channel_{{ channel.id }}"
                       value="{{ channel.id }}"
                       data-group="{{ group_key }}"
                       {% if channel.default %}checked{% endif %}>
                <label class="form-check-label" for="channel_{{ channel.id }}">
                    {{ channel.label }}
                </label>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="mt-4">
            <button id="updateChartsBtn" class="btn btn-primary w-100">
                <i class="bi bi-arrow-clockwise"></i> Update Charts
            </button>
        </div>
    </div>

    <!-- Main Content: Charts and Map -->
    <div class="main-content">
        <div class="filter-bar">
            <div class="row g-2">
                <div class="col-md-5">
                    <label for="trackFilter" class="form-label small mb-1">Track</label>
                    <select id="trackFilter" class="form-select form-select-sm">
                        <option value="">All Tracks</option>
                        {% for track in tracks %}
                        <option value="{{ track.id }}" {% if selected_track and track.id == selected_track.id %}selected{% endif %}>
                            {{ track.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="carFilter" class="form-label small mb-1">Car</label>
                    <select id="carFilter" class="form-select form-select-sm">
                        <option value="">All Cars</option>
                        {% for car in cars %}
                        <option value="{{ car.id }}" {% if selected_car and car.id == selected_car.id %}selected{% endif %}>
                            {{ car.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeTeamFilter" checked>
                        <label class="form-check-label small" for="includeTeamFilter">
                            Include Teammates
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Laps Display -->
        <div class="current-laps-container" id="currentLapsContainer">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted">Currently Viewing:</span>
                <button id="clearAllLaps" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Clear All
                </button>
            </div>
            <div id="currentLapsChips">
                <!-- Lap chips will be added dynamically -->
            </div>
        </div>

        <!-- Charts Container -->
        <div id="chartsContainer">
            {% if initial_laps %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-hourglass-split"></i> Loading telemetry data...
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-graph-up"></i>
                    <h5>No Data Available</h5>
                    <p>Upload some telemetry data to get started, or select a track and car combination.</p>
                    <a href="{% url 'telemetry:upload' %}" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload Telemetry
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Map Container -->
        <div id="mapContainer" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
                <h6 class="mb-0">Track Map</h6>
                <button id="toggleMapBackground" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-map"></i> Hide Background
                </button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Right Sidebar: Fastest Laps -->
    <div class="laps-sidebar" id="lapsSidebar">
        <button id="toggleRightSidebar" class="sidebar-toggle">
            <i class="bi bi-chevron-right"></i>
        </button>
        <h6 class="mb-3">Fastest Laps</h6>

        <!-- My Laps -->
        <div class="section-title">My Laps</div>
        <div id="myLapsContainer">
            <div class="text-center text-muted small py-3">
                <i class="bi bi-hourglass-split"></i> Loading...
            </div>
        </div>

        <!-- Teammates' Laps -->
        <div class="section-title mt-4">Teammates</div>
        <div id="teamLapsContainer">
            <div class="text-center text-muted small py-3">
                <i class="bi bi-hourglass-split"></i> Loading...
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Global State Management
// ============================================================================
const state = {
    activeLaps: [], // Array of {id, color, data}
    selectedTrackId: {{ selected_track.id|default:"null" }},
    selectedCarId: {{ selected_car.id|default:"null" }},
    includeTeam: true,
    colors: ['#00d1b2', '#ff6b6b', '#4ecdc4', '#ffe66d', '#a8dadc', '#f1fa8c', '#ff79c6', '#bd93f9'],
    map: null,
    mapTileLayer: null,
    mapMarkers: [],
};

// Format lap time (seconds to MM:SS.mmm)
function formatLapTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = (seconds % 60).toFixed(3);
    return `${minutes}:${secs.padStart(6, '0')}`;
}

// Get next available color
function getNextColor() {
    const usedColors = state.activeLaps.map(lap => lap.color);
    for (const color of state.colors) {
        if (!usedColors.includes(color)) {
            return color;
        }
    }
    return state.colors[0]; // Fallback
}

// ============================================================================
// Initialization
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized');
    console.log('Initial laps check:', {{ initial_laps|length }});

    // Initialize with default laps if any
    {% if initial_laps %}
    console.log('Loading initial laps...');
    // Load initial laps asynchronously
    loadInitialLaps();
    {% else %}
    console.log('No initial laps to load');
    {% endif %}

    // Load fastest laps
    console.log('Loading fastest laps API call...');
    loadFastestLaps();

    // Event listeners
    document.getElementById('trackFilter').addEventListener('change', onFilterChange);
    document.getElementById('carFilter').addEventListener('change', onFilterChange);
    document.getElementById('includeTeamFilter').addEventListener('change', onFilterChange);
    document.getElementById('updateChartsBtn').addEventListener('click', updateCharts);
    document.getElementById('clearAllLaps').addEventListener('click', clearAllLaps);
    document.getElementById('toggleMapBackground').addEventListener('click', toggleMapBackground);

    // Sidebar collapse/expand
    document.getElementById('toggleLeftSidebar').addEventListener('click', toggleLeftSidebar);
    document.getElementById('toggleRightSidebar').addEventListener('click', toggleRightSidebar);
    document.getElementById('toggleLeftFloating').addEventListener('click', toggleLeftSidebar);
    document.getElementById('toggleRightFloating').addEventListener('click', toggleRightSidebar);

    // Channel selector: All/None buttons
    document.querySelectorAll('.select-all').forEach(btn => {
        btn.addEventListener('click', function() {
            const group = this.dataset.group;
            document.querySelectorAll(`.channel-input[data-group="${group}"]`).forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    });

    document.querySelectorAll('.select-none').forEach(btn => {
        btn.addEventListener('click', function() {
            const group = this.dataset.group;
            document.querySelectorAll(`.channel-input[data-group="${group}"]`).forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    });
});

// ============================================================================
// Lap Loading and Management
// ============================================================================
async function loadInitialLaps() {
    console.log('loadInitialLaps() called');
    {% for lap in initial_laps %}
    console.log('Loading lap ID: {{ lap.id }}');
    await addLapToView({{ lap.id }});
    {% endfor %}
    console.log('All initial laps loaded');
}

async function addLapToView(lapId) {
    console.log(`addLapToView(${lapId}) called`);

    // Check if lap already loaded
    if (state.activeLaps.find(l => l.id === lapId)) {
        console.log(`Lap ${lapId} already loaded, skipping`);
        return;
    }

    // Check lap limit (max 8 laps)
    if (state.activeLaps.length >= 8) {
        alert('Maximum 8 laps can be compared at once');
        return;
    }

    try {
        // Fetch lap telemetry data
        console.log(`Fetching telemetry for lap ${lapId}...`);
        const response = await fetch(`/api/laps/${lapId}/telemetry/`);
        const data = await response.json();
        console.log(`Received response for lap ${lapId}:`, data);

        if (!data.success) {
            alert(data.error || 'Failed to load lap data');
            return;
        }

        // Add lap to state
        const color = getNextColor();
        console.log(`Adding lap ${lapId} to state with color ${color}`);
        state.activeLaps.push({
            id: lapId,
            color: color,
            data: data.lap,
            telemetry: data.telemetry
        });

        console.log(`State now has ${state.activeLaps.length} laps`);

        // Update UI
        updateCurrentLapsChips();
        updateCharts();

    } catch (error) {
        console.error('Error loading lap:', error);
        alert('Failed to load lap data');
    }
}

function removeLapFromView(lapId) {
    state.activeLaps = state.activeLaps.filter(lap => lap.id !== lapId);
    updateCurrentLapsChips();
    updateCharts();
}

function clearAllLaps() {
    state.activeLaps = [];
    updateCurrentLapsChips();
    document.getElementById('chartsContainer').innerHTML = `
        <div class="empty-state">
            <i class="bi bi-graph-up"></i>
            <h5>No Laps Selected</h5>
            <p>Select laps from the right panel to begin analysis.</p>
        </div>
    `;
    if (state.map) {
        state.map.remove();
        state.map = null;
    }
    document.getElementById('mapContainer').style.display = 'none';
}

function updateCurrentLapsChips() {
    const container = document.getElementById('currentLapsChips');
    if (state.activeLaps.length === 0) {
        container.innerHTML = '<span class="small text-muted">No laps selected</span>';
        return;
    }

    container.innerHTML = state.activeLaps.map(lap => `
        <div class="current-lap-chip">
            <span class="lap-color-indicator" style="background-color: ${lap.color};"></span>
            <span>${lap.data.driver} - ${formatLapTime(lap.data.lap_time)}</span>
            <button type="button" class="btn-close btn-close-white" onclick="removeLapFromView(${lap.id})"></button>
        </div>
    `).join('');
}

// ============================================================================
// Chart Generation
// ============================================================================
async function updateCharts() {
    if (state.activeLaps.length === 0) {
        return;
    }

    // Get selected channels
    const selectedChannels = Array.from(document.querySelectorAll('.channel-input:checked'))
        .map(checkbox => checkbox.value);

    if (selectedChannels.length === 0) {
        alert('Please select at least one channel to display');
        return;
    }

    // Show loading indicator
    document.getElementById('chartsContainer').innerHTML = `
        <div class="text-center text-muted py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating charts...</p>
        </div>
    `;

    try {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         getCookie('csrftoken');

        // Call API to generate charts
        const response = await fetch('/api/generate-chart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                lap_ids: state.activeLaps.map(lap => lap.id),
                channels: selectedChannels
            })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to generate charts');
        }

        // Render Plotly chart from JSON
        const chartContainer = document.getElementById('chartsContainer');
        chartContainer.innerHTML = '<div id="telemetryChart"></div>';

        const chartData = JSON.parse(data.chart_json);
        Plotly.newPlot('telemetryChart', chartData.data, chartData.layout, {responsive: true});

        // Show map container
        document.getElementById('mapContainer').style.display = 'block';
        initializeMap();

    } catch (error) {
        console.error('Error generating charts:', error);
        document.getElementById('chartsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Failed to generate charts: ${error.message}
            </div>
        `;
    }
}

// Helper function to get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function initializeMap() {
    // Clear existing map if any
    if (state.map) {
        state.map.remove();
        state.map = null;
        state.mapTileLayer = null;
    }

    // Check if we have GPS data
    if (state.activeLaps.length === 0) {
        return;
    }

    const firstLap = state.activeLaps[0];
    const gpsData = firstLap.telemetry;

    if (!gpsData.Lat || !gpsData.Lon || gpsData.Lat.length === 0) {
        console.log('No GPS data available');
        return;
    }

    // Create map centered on first coordinate with higher max zoom
    const centerLat = gpsData.Lat[0];
    const centerLon = gpsData.Lon[0];
    state.map = L.map('map', {
        maxZoom: 22,  // Allow zooming in much closer
        minZoom: 10
    }).setView([centerLat, centerLon], 15);

    // Add tile layer and store reference for toggling
    state.mapTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(state.map);

    // Add track line for each lap
    state.activeLaps.forEach(lap => {
        if (lap.telemetry.Lat && lap.telemetry.Lon) {
            const coordinates = lap.telemetry.Lat.map((lat, idx) => [lat, lap.telemetry.Lon[idx]]);
            L.polyline(coordinates, {
                color: lap.color,
                weight: 3,
                opacity: 0.7
            }).addTo(state.map);
        }
    });

    // Fit map to show all tracks
    if (state.activeLaps.length > 0 && state.activeLaps[0].telemetry.Lat) {
        const allCoordinates = state.activeLaps.flatMap(lap =>
            lap.telemetry.Lat ? lap.telemetry.Lat.map((lat, idx) => [lat, lap.telemetry.Lon[idx]]) : []
        );
        if (allCoordinates.length > 0) {
            state.map.fitBounds(allCoordinates);
        }
    }
}

function toggleMapBackground() {
    if (!state.map || !state.mapTileLayer) {
        return;
    }

    const btn = document.getElementById('toggleMapBackground');
    if (state.map.hasLayer(state.mapTileLayer)) {
        state.map.removeLayer(state.mapTileLayer);
        btn.innerHTML = '<i class="bi bi-map"></i> Show Background';
    } else {
        state.map.addLayer(state.mapTileLayer);
        btn.innerHTML = '<i class="bi bi-map"></i> Hide Background';
    }
}

// ============================================================================
// Sidebar Toggle Functions
// ============================================================================
function toggleLeftSidebar() {
    const sidebar = document.getElementById('channelSidebar');
    const btn = document.getElementById('toggleLeftSidebar');
    const floatingBtn = document.getElementById('toggleLeftFloating');

    sidebar.classList.toggle('collapsed');

    if (sidebar.classList.contains('collapsed')) {
        btn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        floatingBtn.style.display = 'block';
    } else {
        btn.innerHTML = '<i class="bi bi-chevron-left"></i>';
        floatingBtn.style.display = 'none';
    }
}

function toggleRightSidebar() {
    const sidebar = document.getElementById('lapsSidebar');
    const btn = document.getElementById('toggleRightSidebar');
    const floatingBtn = document.getElementById('toggleRightFloating');

    sidebar.classList.toggle('collapsed');

    if (sidebar.classList.contains('collapsed')) {
        btn.innerHTML = '<i class="bi bi-chevron-left"></i>';
        floatingBtn.style.display = 'block';
    } else {
        btn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        floatingBtn.style.display = 'none';
    }
}

// ============================================================================
// Fastest Laps Loading
// ============================================================================
async function loadFastestLaps() {
    console.log(`loadFastestLaps() called - track: ${state.selectedTrackId}, car: ${state.selectedCarId}`);

    if (!state.selectedTrackId || !state.selectedCarId) {
        console.log('No track/car selected, showing empty state');
        document.getElementById('myLapsContainer').innerHTML = `
            <div class="text-center text-muted small py-3">
                Select a track and car to view fastest laps
            </div>
        `;
        document.getElementById('teamLapsContainer').innerHTML = `
            <div class="text-center text-muted small py-3">
                Select a track and car to view teammates
            </div>
        `;
        return;
    }

    try {
        const url = `/api/fastest-laps/?track_id=${state.selectedTrackId}&car_id=${state.selectedCarId}&include_team=${state.includeTeam}`;
        console.log(`Fetching fastest laps: ${url}`);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Fastest laps response:', data);

        if (!data.success) {
            throw new Error(data.error || 'Failed to load laps');
        }

        // Render user laps
        renderLapsList(data.user_laps, 'myLapsContainer', true);

        // Render teammate laps
        if (state.includeTeam) {
            renderLapsList(data.teammate_laps, 'teamLapsContainer', false);
        } else {
            document.getElementById('teamLapsContainer').innerHTML = `
                <div class="text-center text-muted small py-3">
                    Enable "Include Teammates" to view team laps
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading fastest laps:', error);
        document.getElementById('myLapsContainer').innerHTML = `
            <div class="text-center text-danger small py-3">
                <i class="bi bi-exclamation-triangle"></i> Error loading laps
            </div>
        `;
    }
}

function renderLapsList(laps, containerId, isUserLaps) {
    const container = document.getElementById(containerId);

    if (!laps || laps.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted small py-3">
                No laps found
            </div>
        `;
        return;
    }

    container.innerHTML = laps.map(lap => {
        const isActive = state.activeLaps.some(l => l.id === lap.id);
        const activeLap = state.activeLaps.find(l => l.id === lap.id);

        return `
            <div class="lap-item ${isActive ? 'active' : ''}" onclick="addLapToView(${lap.id})">
                ${isActive ? `<span class="lap-color-indicator" style="background-color: ${activeLap.color};"></span>` : ''}
                <div class="lap-time">
                    ${formatLapTime(lap.lap_time)}
                    ${lap.is_personal_best ? '<span class="pb-badge">PB</span>' : ''}
                </div>
                <div class="lap-meta">
                    ${lap.driver ? lap.driver + ' - ' : ''}Lap #${lap.lap_number}
                    ${lap.session_date ? '<br>' + new Date(lap.session_date).toLocaleDateString() : ''}
                </div>
            </div>
        `;
    }).join('');
}

function onFilterChange() {
    state.selectedTrackId = document.getElementById('trackFilter').value || null;
    state.selectedCarId = document.getElementById('carFilter').value || null;
    state.includeTeam = document.getElementById('includeTeamFilter').checked;

    loadFastestLaps();
}
</script>
{% endblock %}
