{% extends 'telemetry/base.html' %}

{% block title %}Import Lap - Ridgway Garage{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4">
            <a href="{% url 'telemetry:home' %}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-download text-primary"></i> Import Lap
                </h1>
                <p class="text-muted mb-0">Import a lap file shared by another driver</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="importForm">
                    {% csrf_token %}

                    <!-- File Upload Dropzone -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Lap File *</label>
                        <div class="upload-dropzone" id="dropzone">
                            <i class="bi bi-file-earmark-zip"></i>
                            <h5 class="mt-3">Drag & Drop .lap.gz File Here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file"
                                   name="lap_file"
                                   id="id_lap_file"
                                   class="d-none"
                                   accept=".lap.gz"
                                   required>
                            <div id="fileInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-check"></i>
                                    <strong id="fileName"></strong>
                                    <span id="fileSize" class="text-muted"></span>
                                    <button type="button" class="btn-close float-end" id="clearFile"></button>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            Upload a .lap.gz file exported from Ridgway Garage
                        </small>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-download"></i> Import Lap
                        </button>
                        <a href="{% url 'telemetry:home' %}" class="btn btn-outline-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="row g-3 mt-4">
            <div class="col-md-6">
                <div class="card bg-primary bg-opacity-10 border-primary">
                    <div class="card-body">
                        <h6 class="text-primary">
                            <i class="bi bi-info-circle"></i> Sharing Laps
                        </h6>
                        <p class="small mb-0">
                            Drivers can export laps from the lap detail page and share the .lap.gz file with teammates for comparison.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-success bg-opacity-10 border-success">
                    <div class="card-body">
                        <h6 class="text-success">
                            <i class="bi bi-graph-up"></i> Compare Performance
                        </h6>
                        <p class="small mb-0">
                            After importing, add the lap to an Analysis to compare it side-by-side with your own laps.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="card bg-info bg-opacity-10 border-info">
                    <div class="card-body">
                        <h6 class="text-info">
                            <i class="bi bi-shield-check"></i> File Format
                        </h6>
                        <p class="small mb-0">
                            Lap files (.lap.gz) contain compressed telemetry data, session info, and lap times. Only files exported from Ridgway Garage (format version 1.0) are supported.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('id_lap_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const clearBtn = document.getElementById('clearFile');
    const submitBtn = document.getElementById('submitBtn');

    // Click to browse
    dropzone.addEventListener('click', function(e) {
        if (e.target !== clearBtn) {
            fileInput.click();
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    });

    // File input change
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = '(' + formatFileSize(file.size) + ')';
            fileInfo.style.display = 'block';
        }
    }

    // Clear file
    clearBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.value = '';
        fileInfo.style.display = 'none';
    });

    // Form submission
    document.getElementById('importForm').addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
