{% extends 'telemetry/base.html' %}

{% block title %}Live Sessions - Ridgway Garage{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-broadcast"></i> Live Telemetry Sessions</h1>
            <div>
                {% if connected_clients %}
                <span class="badge bg-info fs-5 me-2">
                    {{ connected_clients|length }} Connected
                </span>
                {% endif %}
                <span class="badge bg-success fs-5">
                    {{ active_sessions.count }} Streaming
                </span>
            </div>
        </div>

        <!-- Connected Clients (Waiting for Data) -->
        {% if connected_clients %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="bi bi-plug"></i> Connected Clients (Waiting for iRacing)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Connected</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in connected_clients %}
                            <tr>
                                <td>
                                    <i class="bi bi-person-circle text-info"></i>
                                    <strong>{{ client.driver_name }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-warning">
                                        <i class="bi bi-hourglass-split"></i> Waiting for data
                                    </span>
                                </td>
                                <td>
                                    <span class="text-muted">
                                        Connected
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Active Sessions -->
        {% if active_sessions %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-wifi"></i> Active Sessions
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Track</th>
                                <th>Car</th>
                                <th>Team</th>
                                <th>Current Lap</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in active_sessions %}
                            <tr>
                                <td>
                                    <i class="bi bi-person-circle text-success"></i>
                                    <strong>{{ session.driver.username }}</strong>
                                    {% if session.driver_name %}
                                    <br><small class="text-muted">{{ session.driver_name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="bi bi-flag"></i>
                                    {{ session.track.name|default:"Unknown Track" }}
                                    {% if session.track.configuration %}
                                    <br><small class="text-muted">{{ session.track.configuration }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="bi bi-car-front"></i>
                                    {{ session.car.name|default:"Unknown Car" }}
                                </td>
                                <td>
                                    {% if session.team %}
                                    <i class="bi bi-people"></i>
                                    <a href="{% url 'telemetry:team_detail' session.team.pk %}">
                                        {{ session.team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">
                                        Lap {{ session.laps.count }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-success">
                                        <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>
                                        {{ session.last_telemetry_update|timesince }} ago
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'telemetry:live_session_detail' session.pk %}" class="btn btn-sm btn-success">
                                        <i class="bi bi-eye"></i> Watch Live
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        {% if not connected_clients %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>No active connections</strong> - No drivers are currently connected or streaming telemetry.
            <br>
            <small class="text-muted">Drivers will appear here when they connect the iRacing telemetry client.</small>
        </div>
        {% endif %}
        {% endif %}

        <!-- Recently Disconnected Sessions -->
        {% if recent_sessions %}
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-clock-history"></i> Recently Disconnected (Last 5 minutes)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Track</th>
                                <th>Car</th>
                                <th>Laps</th>
                                <th>Ended</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <i class="bi bi-person-circle text-muted"></i>
                                    {{ session.driver.username }}
                                </td>
                                <td>{{ session.track.name|default:"Unknown" }}</td>
                                <td>{{ session.car.name|default:"Unknown" }}</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ session.laps.count }} laps
                                    </span>
                                </td>
                                <td>
                                    <span class="text-muted">
                                        {{ session.last_telemetry_update|timesince }} ago
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'telemetry:session_detail' session.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View Session
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-question-circle"></i> How to Stream Live Telemetry
            </div>
            <div class="card-body">
                <ol>
                    <li>Download the iRacing Telemetry Client for Windows</li>
                    <li>Configure it with your Driver ID and server URL</li>
                    <li>Launch iRacing and join a session</li>
                    <li>Run the client - your session will appear here automatically</li>
                    <li>Click "Watch Live" to view real-time telemetry data</li>
                </ol>
                <a href="{{ STATIC_URL }}docs/live_telemetry_setup.pdf" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-download"></i> Download Setup Guide
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 5 seconds to show new sessions
setTimeout(function() {
    location.reload();
}, 5000);
</script>
{% endblock %}
