{% extends 'telemetry/base.html' %}
{% load telemetry_filters %}

{% block title %}My Sessions - Ridgway Garage{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-folder"></i> My Sessions</h1>
            <a href="{% url 'telemetry:upload' %}" class="btn btn-primary">
                <i class="bi bi-upload"></i> Upload New
            </a>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Track</label>
                        <select name="track" class="form-select">
                            <option value="">All Tracks</option>
                            {% for track in tracks %}
                            <option value="{{ track.id }}" {% if current_track == track.id|stringformat:"s" %}selected{% endif %}>
                                {{ track.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Car</label>
                        <select name="car" class="form-select">
                            <option value="">All Cars</option>
                            {% for car in cars %}
                            <option value="{{ car.id }}" {% if current_car == car.id|stringformat:"s" %}selected{% endif %}>
                                {{ car.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">All Status</option>
                            <option value="completed" {% if current_status == "completed" %}selected{% endif %}>Completed</option>
                            <option value="processing" {% if current_status == "processing" %}selected{% endif %}>Processing</option>
                            <option value="failed" {% if current_status == "failed" %}selected{% endif %}>Failed</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                        <a href="{% url 'telemetry:session_list' %}" class="btn btn-outline-secondary">
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sessions -->
        {% if sessions %}
        <div class="row g-3">
            {% for session in sessions %}
            <div class="col-12">
                <div class="card session-card {{ session.processing_status }}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-2">
                                    {% if session.track %}
                                        {{ session.track.name }}
                                    {% else %}
                                        <span class="text-muted">Detecting track...</span>
                                    {% endif %}
                                </h5>
                                <p class="text-muted mb-2">
                                    <i class="bi bi-car-front"></i>
                                    {% if session.car %}
                                        {{ session.car.name }}
                                    {% else %}
                                        Detecting car...
                                    {% endif %}
                                    &nbsp;&nbsp;|&nbsp;&nbsp;
                                    <i class="bi bi-calendar"></i> {{ session.session_date|date:"M d, Y H:i" }}
                                    {% if session.air_temp %}
                                    &nbsp;&nbsp;|&nbsp;&nbsp;
                                    <span class="{% if session.air_temp < 15 %}temp-cold{% elif session.air_temp < 25 %}temp-moderate{% elif session.air_temp < 35 %}temp-hot{% else %}temp-extreme{% endif %}">
                                        <i class="bi bi-thermometer-half"></i> {{ session.air_temp }}Â°C
                                    </span>
                                    {% endif %}
                                </p>
                                <span class="badge badge-session-type badge-{{ session.session_type }}">{{ session.get_session_type_display }}</span>
                                {% if session.team %}
                                <span class="badge bg-info"><i class="bi bi-people"></i> {{ session.team.name }}</span>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small mb-1"><i class="bi bi-flag"></i> Laps: <strong>{{ session.laps.count }}</strong></div>
                                {% if session.best_lap %}
                                <div>
                                    <span class="text-muted small">Best:</span>
                                    <span class="lap-time fastest d-block" style="font-size: 1.2em;">
                                        {{ session.best_lap.lap_time|format_laptime }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 text-end">
                                {% if session.processing_status == 'completed' %}
                                <span class="badge bg-success mb-2">Completed</span>
                                <br>
                                <a href="{% url 'telemetry:session_detail' session.pk %}" class="btn btn-sm btn-primary me-1">
                                    View Details <i class="bi bi-arrow-right"></i>
                                </a>
                                <form method="post" action="{% url 'telemetry:session_delete' session.pk %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this session and all its laps?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete session">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% elif session.processing_status == 'processing' %}
                                <span class="badge bg-warning processing mb-2">Processing...</span>
                                <br>
                                <a href="{% url 'telemetry:session_detail' session.pk %}" class="btn btn-sm btn-outline-secondary me-1">
                                    View Progress
                                </a>
                                <form method="post" action="{% url 'telemetry:session_delete' session.pk %}" class="d-inline" onsubmit="return confirm('This session is still processing. Are you sure you want to delete it?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete session">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% elif session.processing_status == 'failed' %}
                                <span class="badge bg-danger mb-2">Failed</span>
                                <br>
                                <small class="text-danger d-block mb-2">{{ session.processing_error|truncatewords:10 }}</small>
                                <form method="post" action="{% url 'telemetry:session_delete' session.pk %}" class="d-inline" onsubmit="return confirm('Delete this failed session?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete session">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </form>
                                {% else %}
                                <span class="badge bg-secondary mb-2">Pending</span>
                                <br>
                                <form method="post" action="{% url 'telemetry:session_delete' session.pk %}" class="d-inline" onsubmit="return confirm('Delete this pending session?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete session">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <i class="bi bi-folder-x empty-state-icon"></i>
                    <h3 class="empty-state-title">No Sessions Found</h3>
                    <p class="empty-state-message">
                        {% if current_track or current_car or current_status %}
                            Try adjusting your filters or upload new sessions to see them here.
                        {% else %}
                            Start your telemetry journey by uploading your first iRacing session file!
                        {% endif %}
                    </p>
                    <div class="empty-state-actions">
                        {% if current_track or current_car or current_status %}
                            <a href="{% url 'telemetry:session_list' %}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        {% endif %}
                        <a href="{% url 'telemetry:upload' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Upload Session
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
