{% extends 'telemetry/base.html' %}
{% load static %}

{% block title %}System Update - Ridgway Garage{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-arrow-clockwise"></i> System Update</h1>
                <p class="text-muted">Manage system updates and view update history</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Version Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Current Version</h5>
            </div>
            <div class="card-body">
                <h3 class="mb-3">{{ current_version }}</h3>
                <p class="text-muted mb-0">Last checked: <span id="last-check-time">Never</span></p>
            </div>
        </div>
    </div>

    <!-- Update Status Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-cloud-download"></i> Available Updates</h5>
            </div>
            <div class="card-body">
                <div id="update-check-status">
                    <button id="check-updates-btn" class="btn btn-primary">
                        <i class="bi bi-search"></i> Check for Updates
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Card (shown when update is running) -->
{% if running_update %}
<div class="row" id="update-progress-card">
    <div class="col-12 mb-4">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-repeat"></i> Update in Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Status:</strong> <span id="update-status-text">{{ running_update.status_message }}</span>
                </div>
                <div class="progress mb-3" style="height: 30px;">
                    <div id="update-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: {{ running_update.progress }}%"
                         aria-valuenow="{{ running_update.progress }}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        <span id="update-progress-text">{{ running_update.progress }}%</span>
                    </div>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> The update is running. This page will update automatically.
                    Please do not close this page or refresh your browser during the update.
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Updates Card -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Recent Updates</h5>
                <a href="{% url 'telemetry:system_update_history' %}" class="btn btn-sm btn-outline-primary">
                    View All History
                </a>
            </div>
            <div class="card-body">
                {% if recent_updates %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Triggered By</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for update in recent_updates %}
                            <tr>
                                <td>{{ update.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    {% if update.old_version %}{{ update.old_version }}{% endif %}
                                    {% if update.new_version %}
                                        <i class="bi bi-arrow-right"></i> {{ update.new_version }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if update.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                    {% elif update.status == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% elif update.status == 'running' %}
                                        <span class="badge bg-primary">Running</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ update.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ update.triggered_by.username|default:"System" }}</td>
                                <td>
                                    {% if update.duration %}
                                        {{ update.duration|floatformat:0 }}s
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No update history available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Update Confirmation Modal -->
<div class="modal fade" id="updateConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm System Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> The system will be unavailable for 2-5 minutes during the update.
                </div>
                <p>This will update the system to the latest version from GitHub.</p>
                <p><strong>Latest commit:</strong> <span id="modal-commit-info"></span></p>
                <p><strong>Changes:</strong></p>
                <p id="modal-changelog" class="font-monospace small bg-dark p-2 rounded"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'telemetry:system_update_trigger' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-download"></i> Start Update
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkBtn = document.getElementById('check-updates-btn');
    const statusDiv = document.getElementById('update-check-status');
    const lastCheckTime = document.getElementById('last-check-time');

    // WebSocket connection for real-time update progress
    {% if running_update %}
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/system/update/';
    const socket = new WebSocket(wsUrl);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Update progress:', data);

        // Update progress bar
        const progressBar = document.getElementById('update-progress-bar');
        const progressText = document.getElementById('update-progress-text');
        const statusText = document.getElementById('update-status-text');

        if (progressBar) {
            progressBar.style.width = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);
        }
        if (progressText) {
            progressText.textContent = data.progress + '%';
        }
        if (statusText) {
            statusText.textContent = data.message;
        }

        // Handle completion
        if (data.status === 'success') {
            if (progressBar) {
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-success');
            }
            setTimeout(function() {
                window.location.reload();
            }, 3000);
        } else if (data.status === 'failed') {
            if (progressBar) {
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-danger');
            }
        }
    };

    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    socket.onclose = function(e) {
        console.log('WebSocket closed');
    };
    {% endif %}

    // Check for updates button
    if (checkBtn) {
        checkBtn.addEventListener('click', function() {
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Checking...';

            fetch("{% url 'telemetry:system_update_check' %}")
                .then(response => response.json())
                .then(data => {
                    lastCheckTime.textContent = new Date().toLocaleString();

                    if (data.success) {
                        if (data.update_available) {
                            statusDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <h5><i class="bi bi-check-circle"></i> Update Available!</h5>
                                    <p class="mb-2"><strong>Current:</strong> ${data.current_commit}</p>
                                    <p class="mb-2"><strong>Latest:</strong> ${data.latest_commit}</p>
                                    <p class="mb-3"><strong>Changes:</strong> ${data.latest_message}</p>
                                    <button class="btn btn-success" onclick="showUpdateModal('${data.latest_commit}', '${data.latest_message}')">
                                        <i class="bi bi-download"></i> Install Update
                                    </button>
                                </div>
                            `;
                        } else {
                            statusDiv.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-check-circle"></i> You are running the latest version!
                                    <p class="mb-0 mt-2"><strong>Current commit:</strong> ${data.current_commit}</p>
                                </div>
                            `;
                        }
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> Error checking for updates: ${data.error}
                            </div>
                            <button id="check-updates-btn" class="btn btn-primary">
                                <i class="bi bi-search"></i> Try Again
                            </button>
                        `;
                        // Re-attach event listener to new button
                        document.getElementById('check-updates-btn').addEventListener('click', arguments.callee);
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Network error: ${error.message}
                        </div>
                        <button id="check-updates-btn" class="btn btn-primary">
                            <i class="bi bi-search"></i> Try Again
                        </button>
                    `;
                    document.getElementById('check-updates-btn').addEventListener('click', arguments.callee);
                });
        });
    }
});

function showUpdateModal(commit, message) {
    document.getElementById('modal-commit-info').textContent = commit;
    document.getElementById('modal-changelog').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('updateConfirmModal'));
    modal.show();
}
</script>
{% endblock %}
