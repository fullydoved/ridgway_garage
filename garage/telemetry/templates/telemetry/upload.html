{% extends 'telemetry/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Upload Telemetry - Ridgway Garage{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4">
            <a href="{% url 'telemetry:home' %}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-upload text-primary"></i> Upload Telemetry
                </h1>
                <p class="text-muted mb-0">Upload an iRacing telemetry file (.ibt)</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}

                    <!-- File Upload Dropzone -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Telemetry File *</label>
                        <div class="upload-dropzone" id="dropzone">
                            <i class="bi bi-cloud-upload"></i>
                            <h5 class="mt-3">Drag & Drop IBT File Here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file"
                                   name="ibt_file"
                                   id="id_ibt_file"
                                   class="d-none"
                                   accept=".ibt,.IBT"
                                   required>
                            <div id="fileInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-check"></i>
                                    <strong id="fileName"></strong>
                                    <span id="fileSize" class="text-muted"></span>
                                    <button type="button" class="btn-close float-end" id="clearFile"></button>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            {{ form.ibt_file.help_text }}
                        </small>
                        {% if form.ibt_file.errors %}
                        <div class="text-danger mt-2">
                            {{ form.ibt_file.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Team Selection (Optional) -->
                    <div class="mb-4">
                        <label for="{{ form.team.id_for_label }}" class="form-label fw-bold">
                            Team (Optional)
                        </label>
                        {{ form.team }}
                        <small class="form-text text-muted d-block">
                            {{ form.team.help_text }}
                        </small>
                        {% if form.team.errors %}
                        <div class="text-danger">{{ form.team.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-upload"></i> Upload & Process
                        </button>
                        <a href="{% url 'telemetry:home' %}" class="btn btn-outline-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="row g-3 mt-4">
            <div class="col-md-6">
                <div class="card bg-primary bg-opacity-10 border-primary">
                    <div class="card-body">
                        <h6 class="text-primary">
                            <i class="bi bi-info-circle"></i> File Location
                        </h6>
                        <p class="small mb-0">
                            IBT files are located in your iRacing directory:<br>
                            <code>Documents/iRacing/telemetry/[car]/</code>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-success bg-opacity-10 border-success">
                    <div class="card-body">
                        <h6 class="text-success">
                            <i class="bi bi-magic"></i> Auto-Detection
                        </h6>
                        <p class="small mb-0">
                            Track, car, and session type are automatically extracted from your IBT file. No manual entry needed!
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="card bg-info bg-opacity-10 border-info">
                    <div class="card-body">
                        <h6 class="text-info">
                            <i class="bi bi-clock-history"></i> Processing Time
                        </h6>
                        <p class="small mb-0">
                            Large files may take several minutes to process. You can monitor the status from the dashboard.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('id_ibt_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const clearBtn = document.getElementById('clearFile');
    const submitBtn = document.getElementById('submitBtn');

    // Click to browse
    dropzone.addEventListener('click', function(e) {
        if (e.target !== clearBtn) {
            fileInput.click();
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    });

    // File input change
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = '(' + formatFileSize(file.size) + ')';
            fileInfo.style.display = 'block';
        }
    }

    // Clear file
    clearBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.value = '';
        fileInfo.style.display = 'none';
    });

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
