{% extends "base.html" %}
{% load static %}

{% block title %}Analysis Dashboard{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* Sidebar collapse animations */
    .collapsed {
        width: 0 !important;
        min-width: 0 !important;
        padding: 0 !important;
        border: none !important;
        overflow: hidden !important;
    }

    /* Map styling */
    #map {
        height: 400px;
        border-radius: 0.5rem;
        border: 1px solid rgba(0, 212, 255, 0.2);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Floating toggle buttons (shown when sidebars are collapsed) -->
<button id="toggleLeftFloating" class="fixed top-20 left-4 z-50 hidden glass-card px-4 py-2 text-neon-cyan hover:shadow-neon-cyan transition-all">
    ‚ò∞ Channels
</button>
<button id="toggleRightFloating" class="fixed top-20 right-4 z-50 hidden glass-card px-4 py-2 text-neon-cyan hover:shadow-neon-cyan transition-all">
    ‚ò∞ Laps
</button>

<div class="flex h-[calc(100vh-4rem)] overflow-hidden">
    <!-- Left Sidebar: Channel Selector -->
    <div id="channelSidebar" class="w-80 min-w-[20rem] border-r border-cyber-border overflow-y-auto p-4 bg-cyber-dark transition-all duration-300 relative">
        <button id="toggleLeftSidebar" class="absolute top-2 right-2 text-gray-400 hover:text-neon-cyan transition-colors">
            ‚Üê
        </button>

        <h2 class="text-xl font-bold text-neon-cyan mb-4">Telemetry Channels</h2>

        {% for group_key, group in channel_groups.items %}
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-bold uppercase text-neon-cyan tracking-wider">{{ group.name }}</span>
                <div class="flex gap-0 border border-cyber-border rounded-md overflow-hidden">
                    <button type="button" class="select-all px-3 py-1 text-xs text-neon-cyan bg-cyber-dark hover:bg-neon-cyan/20 transition-all duration-200 border-r border-cyber-border font-medium" data-group="{{ group_key }}">‚úì All</button>
                    <button type="button" class="select-none px-3 py-1 text-xs text-gray-400 bg-cyber-dark hover:bg-gray-700 transition-all duration-200 font-medium" data-group="{{ group_key }}">‚úï None</button>
                </div>
            </div>
            {% for channel in group.channels %}
            <div class="flex items-center gap-3 py-1.5 px-2 hover:bg-cyber-dark/50 rounded transition-colors">
                <input class="channel-input w-5 h-5 rounded border-2 border-cyber-border bg-cyber-dark text-neon-cyan focus:ring-neon-cyan focus:ring-2 cursor-pointer transition-all"
                       type="checkbox"
                       id="channel_{{ channel.id }}"
                       value="{{ channel.id }}"
                       data-group="{{ group_key }}"
                       {% if channel.default %}checked{% endif %}>
                <label class="text-sm text-gray-300 cursor-pointer hover:text-white transition-colors flex-1" for="channel_{{ channel.id }}">
                    {{ channel.label }}
                </label>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="mt-6">
            <button id="updateChartsBtn" class="btn-neon w-full text-center">
                ‚Üª Update Charts
            </button>
        </div>
    </div>

    <!-- Main Content: Charts and Map -->
    <div class="flex-1 overflow-y-auto p-6">
        <!-- Filter Bar -->
        <div class="glass-card p-6 corner-brackets mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="trackFilter" class="form-label">Track</label>
                    <select id="trackFilter" class="input-neon">
                        <option value="">All Tracks</option>
                        {% for track in tracks %}
                        <option value="{{ track.id }}" {% if selected_track and track.id == selected_track.id %}selected{% endif %}>
                            {{ track.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="carFilter" class="form-label">Car</label>
                    <select id="carFilter" class="input-neon">
                        <option value="">All Cars</option>
                        {% for car in cars %}
                        <option value="{{ car.id }}" {% if selected_car and car.id == selected_car.id %}selected{% endif %}>
                            {{ car.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-end">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="includeTeamFilter" checked class="w-5 h-5 rounded border-2 border-cyber-border bg-cyber-dark text-neon-cyan focus:ring-neon-cyan focus:ring-2 cursor-pointer transition-all">
                        <span class="text-sm text-gray-300 group-hover:text-white transition-colors">Include Teammates</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Charts Container -->
        <div id="chartsContainer" class="glass-card p-6 corner-brackets mb-6">
            {% if preloaded_lap_id %}
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-neon-cyan"></div>
                    <p class="mt-4 text-gray-400">Loading telemetry data...</p>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <svg class="w-16 h-16 text-neon-cyan mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <h5 class="text-xl font-bold text-white mb-2">No Data Available</h5>
                    <p class="text-gray-400 mb-4">Upload telemetry data to get started, or select a track and car combination.</p>
                    <a href="{% url 'telemetry:upload' %}" class="btn-neon inline-block">
                        ‚Üë Upload Telemetry
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Map Container -->
        <div id="mapContainer" style="display: none;" class="glass-card p-6 corner-brackets">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-neon-cyan">Track Map</h3>
                <button id="toggleMapBackground" class="px-3 py-1 text-sm border border-neon-cyan/50 text-neon-cyan rounded hover:bg-neon-cyan/10 transition-colors">
                    üó∫ Hide Background
                </button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Right Sidebar: Fastest Laps -->
    <div id="lapsSidebar" class="w-80 min-w-[20rem] border-l border-cyber-border overflow-y-auto p-4 bg-cyber-dark transition-all duration-300 relative">
        <button id="toggleRightSidebar" class="absolute top-2 left-2 text-gray-400 hover:text-neon-cyan transition-colors">
            ‚Üí
        </button>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-neon-cyan">Fastest Laps</h2>
            <button id="clearAllLaps" class="px-3 py-1.5 text-xs border-2 border-red-500/50 text-red-400 rounded hover:bg-red-500/10 hover:border-red-500 transition-colors font-medium">
                √ó Clear All
            </button>
        </div>

        <!-- My Laps -->
        <div class="mb-6">
            <h3 class="text-xs font-bold uppercase text-gray-400 mb-3 pb-2 border-b border-cyber-border">My Laps</h3>
            <div id="myLapsContainer">
                <div class="text-center text-gray-500 py-4 text-sm">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-neon-cyan mb-2"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Teammates' Laps -->
        <div>
            <h3 class="text-xs font-bold uppercase text-gray-400 mb-3 pb-2 border-b border-cyber-border">Teammates</h3>
            <div id="teamLapsContainer">
                <div class="text-center text-gray-500 py-4 text-sm">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-neon-cyan mb-2"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS for maps -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Analysis Dashboard JavaScript (ES6 Modules) -->
<script type="module">
    import { state } from '{% static "js/analysis/main.js" %}';

    // Set initial state from Django template
    state.selectedTrackId = {{ selected_track.id|default:"null" }};
    state.selectedCarId = {{ selected_car.id|default:"null" }};

    {% if preloaded_lap_id %}
    // Set preloaded lap ID if provided via query parameter
    state.preloadedLapId = {{ preloaded_lap_id }};
    {% endif %}

    {% if preloaded_session_laps %}
    // Set preloaded session laps if provided (comma-separated IDs)
    state.preloadedSessionLaps = "{{ preloaded_session_laps }}".split(',').map(id => parseInt(id));
    {% endif %}
</script>
{% endblock %}
